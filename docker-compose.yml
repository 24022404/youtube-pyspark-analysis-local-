version: '3.8'

services:
  # ========================================
  # ZOOKEEPER - Kafka dependency
  # ========================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - youtube-network

  # ========================================
  # KAFKA BROKER
  # ========================================
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
    networks:
      - youtube-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # MONGODB - Lưu historical + real-time data
  # ========================================
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: youtube_analytics
    volumes:
      - mongodb_data:/data/db
    networks:
      - youtube-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # SPARK MASTER
  # ========================================
  spark-master:
    image: bitnami/spark:3.5.0
    container_name: spark-master
    environment:
      - SPARK_MODE=master
      - SPARK_MASTER_HOST=spark-master
      - SPARK_MASTER_PORT=7077
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - "8080:8080"  # Spark Master Web UI
      - "7077:7077"  # Spark Master Port
    networks:
      - youtube-network
    volumes:
      - ./src:/opt/spark-apps
      - ./data:/opt/spark-data
      - ./models:/opt/spark-models

  # ========================================
  # SPARK WORKER 1
  # ========================================
  spark-worker-1:
    image: bitnami/spark:3.5.0
    container_name: spark-worker-1
    depends_on:
      - spark-master
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=2G
      - SPARK_WORKER_CORES=2
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
    ports:
      - "8081:8081"
    networks:
      - youtube-network
    volumes:
      - ./src:/opt/spark-apps
      - ./data:/opt/spark-data
      - ./models:/opt/spark-models

  # ========================================
  # KAFKA PRODUCER (YouTube API → Kafka)
  # ========================================
  kafka-producer:
    build:
      context: ./src
      dockerfile: Dockerfile.producer
    container_name: kafka-producer
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY}
      - FETCH_INTERVAL=60
    networks:
      - youtube-network
    restart: unless-stopped
    volumes:
      - ./src:/app
      - ./data:/app/data

  # ========================================
  # SPARK STREAMING JOB (Kafka → Analysis → MongoDB)
  # ========================================
  spark-streaming:
    build:
      context: ./src
      dockerfile: Dockerfile.streaming
    container_name: spark-streaming
    depends_on:
      kafka:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      spark-master:
        condition: service_started
    environment:
      - SPARK_MASTER_URL=spark://spark-master:7077
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - MONGO_URI=mongodb://admin:admin123@mongodb:27017/youtube_analytics?authSource=admin
    networks:
      - youtube-network
    volumes:
      - ./src:/opt/spark-apps
      - ./data:/opt/spark-data
      - ./models:/opt/spark-models
    command: >
      spark-submit
      --master spark://spark-master:7077
      --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.0,org.mongodb.spark:mongo-spark-connector_2.12:10.2.1
      --conf spark.mongodb.write.connection.uri=mongodb://admin:admin123@mongodb:27017/youtube_analytics?authSource=admin
      /opt/spark-apps/spark_streaming.py

  # ========================================
  # FLASK DASHBOARD BACKEND (WebSocket + API)
  # ========================================
  dashboard-backend:
    build:
      context: ./dashboard/backend
      dockerfile: Dockerfile
    container_name: dashboard-backend
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "5000:5000"
    environment:
      - MONGO_URI=mongodb://admin:admin123@mongodb:27017/youtube_analytics?authSource=admin
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - FLASK_ENV=production
    networks:
      - youtube-network
    volumes:
      - ./dashboard/backend:/app
    restart: unless-stopped

  # ========================================
  # NGINX - Serve Frontend Dashboard
  # ========================================
  dashboard-frontend:
    image: nginx:alpine
    container_name: dashboard-frontend
    ports:
      - "80:80"
    volumes:
      - ./dashboard/frontend:/usr/share/nginx/html:ro
      - ./dashboard/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - youtube-network
    depends_on:
      - dashboard-backend

# ========================================
# NETWORKS
# ========================================
networks:
  youtube-network:
    driver: bridge

# ========================================
# VOLUMES
# ========================================
volumes:
  mongodb_data:
    driver: local